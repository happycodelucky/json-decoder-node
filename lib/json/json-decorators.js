"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("reflect-metadata");
const createDebugLog = require("debug");
const decoder_declarations_1 = require("../decoder/decoder-declarations");
const decoder_declarations_2 = require("../decoder/decoder-declarations");
const decoder_map_1 = require("../decoder/decoder-map");
const json_symbols_1 = require("./json-symbols");
const debug = createDebugLog('decoder:json');
function jsonDecodable(options) {
    return (target) => {
        debug(`${target.name} applying jsonDecodable with options ${JSON.stringify(options)}`);
        Reflect.defineMetadata(decoder_declarations_1.DecoderMetadataKeys.decodable, true, target);
        const decodableOptions = Object.assign({}, options);
        Reflect.defineMetadata(decoder_declarations_1.DecoderMetadataKeys.decodableOptions, decodableOptions, target);
        return target;
    };
}
exports.jsonDecodable = jsonDecodable;
function jsonSchema(schema, ...references) {
    return (target) => {
        debug(`${target.name} applying jsonSchema`);
        const schemaMetadata = {
            schema,
            references,
        };
        Reflect.defineMetadata(json_symbols_1.JsonDecoderMetadataKeys.schema, schemaMetadata, target);
        return target;
    };
}
exports.jsonSchema = jsonSchema;
function jsonContext(target, key) {
    debug(`${target.constructor.name} applying jsonContext to ${key}`);
    Reflect.defineMetadata(json_symbols_1.JsonDecoderMetadataKeys.context, key, target.constructor);
    const descriptor = Reflect.getOwnPropertyDescriptor(target, key);
    Reflect.defineProperty(target, key, {
        configurable: true,
        writable: true,
        enumerable: false,
        value: !!descriptor ? descriptor.value : undefined,
    });
    if (!('toJSON' in target)) {
        target['toJSON'] = function toJSON() {
            return Object.assign({}, this[key]);
        };
    }
}
exports.jsonContext = jsonContext;
function jsonProperty(target, key) {
    debug(`${target.constructor.name} applying jsonProperty to ${key}`);
    const decoderMap = decoder_map_1.decoderMapEntryForTarget(key, target.constructor);
    if (typeof decoderMap.key !== 'string' || decoderMap.key.length === 0) {
        decoderMap.key = key;
    }
}
exports.jsonProperty = jsonProperty;
function jsonPropertyAlias(keyPath) {
    if (typeof keyPath !== 'string' || keyPath.length === 0) {
        throw new TypeError('jsonProperty(keyPath) should be a non-empty String');
    }
    return (target, key) => {
        const decoderMap = decoder_map_1.decoderMapEntryForTarget(key, target.constructor);
        if (keyPath) {
            decoderMap.key = keyPath;
        }
    };
}
exports.jsonPropertyAlias = jsonPropertyAlias;
function jsonType(type, mapFunction) {
    if (Array.isArray(type) && type.length !== 1) {
        throw new TypeError('jsonType(type) should have exactly one element for Array types');
    }
    return (target, key) => {
        const decoderMapEntry = decoder_map_1.decoderMapEntryForTarget(key, target.constructor);
        const elementType = decoder_declarations_2.isDecoderPrototypalCollectionTarget(type) ? type.collection : type;
        debug(`${target.constructor.name} applying jsonType to ${key}, marshalling using ${elementType.name}`);
        decoderMapEntry.type = type;
        decoderMapEntry.mapFunction = mapFunction;
    };
}
exports.jsonType = jsonType;
function jsonDecoderFactory(target, key, descriptor) {
    debug(`${target.name} applying jsonDecoderFactory to ${key}`);
    Reflect.defineMetadata(decoder_declarations_1.DecoderMetadataKeys.decoderFactory, target[key], target);
    return descriptor;
}
exports.jsonDecoderFactory = jsonDecoderFactory;
function jsonDecoder(target, key, descriptor) {
    debug(`${target.constructor.name} applying jsonDecoder to ${key}`);
    Reflect.defineMetadata(decoder_declarations_1.DecoderMetadataKeys.decoder, target[key], target);
    return descriptor;
}
exports.jsonDecoder = jsonDecoder;
function jsonDecoderCompleted(target, key, descriptor) {
    debug(`${target.constructor.name} applying jsonDecoderCompleted to ${key}`);
    Reflect.defineMetadata(decoder_declarations_1.DecoderMetadataKeys.decoderCompleted, target[key], target);
    return descriptor;
}
exports.jsonDecoderCompleted = jsonDecoderCompleted;
function jsonNotify(keyPath, type) {
    if (typeof keyPath !== 'string') {
        throw new TypeError('jsonPropertyHandler(keyPath) should be a non-empty String');
    }
    if (Array.isArray(type) && type.length !== 1) {
        throw new TypeError('jsonPropertyHandler(type) should have exactly one element for Array types');
    }
    return (target, key, descriptor) => {
        debug(`${target.constructor.name} applying jsonPropertyHandler ${keyPath} to ${key}`);
        let notifiers = Reflect.getOwnMetadata(decoder_declarations_1.DecoderMetadataKeys.decoderNotifiers, target.constructor);
        if (!notifiers) {
            notifiers = new Map();
            Reflect.defineMetadata(decoder_declarations_1.DecoderMetadataKeys.decoderNotifiers, notifiers, target.constructor);
        }
        let propertyNotifiers = notifiers.get(keyPath);
        if (!propertyNotifiers) {
            propertyNotifiers = [];
            notifiers.set(keyPath, propertyNotifiers);
        }
        propertyNotifiers.push({
            key: keyPath,
            type,
            mapFunction: descriptor.value,
        });
        return descriptor;
    };
}
exports.jsonNotify = jsonNotify;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianNvbi1kZWNvcmF0b3JzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2pzb24vanNvbi1kZWNvcmF0b3JzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBSUEsNEJBQXlCO0FBRXpCLHdDQUF1QztBQUV2QywwRUFBMEg7QUFDMUgsMEVBQXdIO0FBQ3hILHdEQUFrRjtBQUVsRixpREFBd0Q7QUFHeEQsTUFBTSxLQUFLLEdBQUcsY0FBYyxDQUFDLGNBQWMsQ0FBQyxDQUFBO0FBMkI1Qyx1QkFBOEIsT0FBOEI7SUFDeEQsT0FBTyxDQUFvQyxNQUFTLEVBQXVCLEVBQUU7UUFDekUsS0FBSyxDQUFDLEdBQUcsTUFBTSxDQUFDLElBQUksd0NBQXdDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQ3RGLE9BQU8sQ0FBQyxjQUFjLENBQUMsMENBQW1CLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQTtRQUduRSxNQUFNLGdCQUFnQixxQkFBNkIsT0FBTyxDQUFDLENBQUE7UUFDM0QsT0FBTyxDQUFDLGNBQWMsQ0FBQywwQ0FBbUIsQ0FBQyxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLENBQUMsQ0FBQTtRQUt0RixPQUE2QixNQUFNLENBQUE7SUFDdkMsQ0FBQyxDQUFBO0FBQ0wsQ0FBQztBQWRELHNDQWNDO0FBMEJELG9CQUEyQixNQUEyQixFQUFFLEdBQUcsVUFBNkQ7SUFDcEgsT0FBTyxDQUFvQyxNQUFTLEVBQUssRUFBRTtRQUN2RCxLQUFLLENBQUMsR0FBRyxNQUFNLENBQUMsSUFBSSxzQkFBc0IsQ0FBQyxDQUFBO1FBQzNDLE1BQU0sY0FBYyxHQUE4QjtZQUM5QyxNQUFNO1lBQ04sVUFBVTtTQUNiLENBQUE7UUFDRCxPQUFPLENBQUMsY0FBYyxDQUFDLHNDQUF1QixDQUFDLE1BQU0sRUFBRSxjQUFjLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFFOUUsT0FBTyxN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IGRlY2xhcmUgb24gSlNPTiBkZWNvZGFibGUgY2xhc3NlcywgcHJvcGVydGllcywgYW5kIGZ1bmN0aW9uc1xuICovXG5cbmltcG9ydCAncmVmbGVjdC1tZXRhZGF0YSdcblxuaW1wb3J0ICogYXMgY3JlYXRlRGVidWdMb2cgZnJvbSAnZGVidWcnXG5cbmltcG9ydCB7IERlY29kZXJDb25zdHJ1Y3RhYmxlVGFyZ2V0LCBEZWNvZGVyTWV0YWRhdGFLZXlzLCBEZWNvZGVyUHJvdG90eXBhbFRhcmdldCB9IGZyb20gJy4uL2RlY29kZXIvZGVjb2Rlci1kZWNsYXJhdGlvbnMnXG5pbXBvcnQgeyBEZWNvZGVyUHJvdG90eXBhbENvbGxlY3Rpb25UYXJnZXQsIGlzRGVjb2RlclByb3RvdHlwYWxDb2xsZWN0aW9uVGFyZ2V0IH0gZnJvbSAnLi4vZGVjb2Rlci9kZWNvZGVyLWRlY2xhcmF0aW9ucydcbmltcG9ydCB7IERlY29kZXJNYXBFbnRyeSwgZGVjb2Rlck1hcEVudHJ5Rm9yVGFyZ2V0IH0gZnJvbSAnLi4vZGVjb2Rlci9kZWNvZGVyLW1hcCdcbmltcG9ydCB7IEpzb25Db252ZXJ0YWJsZSB9IGZyb20gJy4vanNvbi1kZWNvZGFibGUtdHlwZXMnXG5pbXBvcnQgeyBKc29uRGVjb2Rlck1ldGFkYXRhS2V5cyB9IGZyb20gJy4vanNvbi1zeW1ib2xzJ1xuXG4vLyBEZWJ1ZyBsb2dnZXJcbmNvbnN0IGRlYnVnID0gY3JlYXRlRGVidWdMb2coJ2RlY29kZXI6anNvbicpXG5cbi8vXG4vLyBDbGFzcyBkZWNvcmF0b3JzXG4vL1xuXG4vKipcbiAqIE9wdGlvbnMgcHJvdmlkZWQgdG8gYSBganNvbkRlY29kYWJsZWAgY2xhc3NcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBKc29uRGVjb2RhYmxlT3B0aW9ucyB7XG4gICAgLyoqXG4gICAgICogU3RyaWN0IG1vZGVcbiAgICAgKi9cbiAgICBzdHJpY3Q/OiBib29sZWFuXG5cbiAgICAvKipcbiAgICAgKiBXaGVuIHRydWUgd2lsbCBjYWxsIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiAoZGVmYXVsdClcbiAgICAgKiBJZiBhIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGlzIG5vdCB0aGVuIG5vIFR5cGVTY3JpcHQgaW5pdGlhbGl6YXRpb24gb2YgcHJvcGVydGllcyBpcyBwZXJmb3JtZWRcbiAgICAgKi9cbiAgICB1c2VDb25zdHJ1Y3Rvcj86IGJvb2xlYW5cbn1cblxuLyoqXG4gKiBEZWNsYXJlIGEgY2xhc3MgYXMgYmVpbmcgZGVjb2RhYmxlIGZyb20gYSBKU09OIG9iamVjdFxuICpcbiAqIEBwYXJhbSBvcHRpb25zIC0gZGVjb2RlciBvcHRpb25zXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBqc29uRGVjb2RhYmxlKG9wdGlvbnM/OiBKc29uRGVjb2RhYmxlT3B0aW9ucykge1xuICAgIHJldHVybiA8VCBleHRlbmRzIERlY29kZXJQcm90b3R5cGFsVGFyZ2V0Pih0YXJnZXQ6IFQpOiBUICYgSnNvbkNvbnZlcnRhYmxlID0+IHtcbiAgICAgICAgZGVidWcoYCR7dGFyZ2V0Lm5hbWV9IGFwcGx5aW5nIGpzb25EZWNvZGFibGUgd2l0aCBvcHRpb25zICR7SlNPTi5zdHJpbmdpZnkob3B0aW9ucyl9YClcbiAgICAgICAgUmVmbGVjdC5kZWZpbmVNZXRhZGF0YShEZWNvZGVyTWV0YWRhdGFLZXlzLmRlY29kYWJsZSwgdHJ1ZSwgdGFyZ2V0KVxuXG4gICAgICAgIC8vIERlY29kYWJsZSBvcHRpb25zXG4gICAgICAgIGNvbnN0IGRlY29kYWJsZU9wdGlvbnM6IEpzb25EZWNvZGFibGVPcHRpb25zID0gey4uLm9wdGlvbnN9XG4gICAgICAgIFJlZmxlY3QuZGVmaW5lTWV0YWRhdGEoRGVjb2Rlck1ldGFkYXRhS2V5cy5kZWNvZGFibGVPcHRpb25zLCBkZWNvZGFibGVPcHRpb25zLCB0YXJnZXQpXG5cbiAgICAgICAgLy8gY29uc3QgbWFwID0gZGVjb2Rlck1hcEZvclRhcmdldCh0YXJnZXQpO1xuICAgICAgICAvLyBUT0RPOiBPdXRwdXQgdGhlIGRlY29kZXIgbWFwIGZvciB0aGUgdGFyZ2V0LiBOZWVkcyB0byBiZSBzYW5pdGl6ZSB0byBvdXRwdXQgY29ycmVjdGx5XG5cbiAgICAgICAgcmV0dXJuIDxUICYgSnNvbkNvbnZlcnRhYmxlPiB0YXJnZXRcbiAgICB9XG59XG5cbi8qKlxuICogSnNvbiBzY2hlbWEgYXMgdXNlZCBieSBhIEpTT04gZGVjb2RlYWJsZSBvYmplY3RcbiAqIFRPRE86IFVzZSBhbiBpbnRlcmZhY2UgZGVzY3JpYmluZyB0aGUgc3VwcG9ydGVkIHNjaGVtYSB2ZXJzaW9uIChub3QgYXZhaWxhYmxlIGluIGFqdilcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBKc29uRGVjb2RhYmxlU2NoZW1hIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgYW55PiB7XG4gICAgJHNjaGVtYTogc3RyaW5nXG4gICAgJGlkPzogc3RyaW5nXG59XG5cbi8qKlxuICogSW50ZXJmYWNlIGZvciBzY2hlbWEgbWV0YWRhdGEgc2V0IG9uIGEgdGFyZ2V0XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSnNvbkRlY29kZXJTY2hlbWFNZXRhZGF0YSB7XG4gICAgc2NoZW1hOiBKc29uRGVjb2RhYmxlU2NoZW1hLFxuICAgIHJlZmVyZW5jZXM/OiAoSnNvbkRlY29kYWJsZVNjaGVtYSB8IERlY29kZXJQcm90b3R5cGFsVGFyZ2V0KVtdXG59XG5cbi8qKlxuICogQW4gYXNzb2NpYXRlZCBKU09OIHNjaGVtYSB0byB2YWxpZGF0ZSB0aGUgSlNPTiB3aXRoIGJlZm9yZSBkZWNvZGluZ1xuICogU2VlIGh0dHA6Ly9qc29uLXNjaGVtYS5vcmcvXG4gKlxuICogQHBhcmFtIHNjaGVtYSAtIEpTT04gc2NoZW1hIGNvbmZpZ3VyYXRpb25cbiAqIEBwYXJhbSByZWZlcmVuY2VzIC0gSlNPTiBkZWNvZGFibGUgY2xhc3NlcyBvciBzY2hlbWEgcmVmZXJlbmNlc1xuICovXG5leHBvcnQgZnVuY3Rpb24ganNvblNjaGVtYShzY2hlbWE6IEpzb25EZWNvZGFibGVTY2hlbWEsIC4uLnJlZmVyZW5jZXM6IChKc29uRGVjb2RhYmxlU2NoZW1hIHwgRGVjb2RlclByb3RvdHlwYWxUYXJnZXQpW10pIHtcbiAgICByZXR1cm4gPFQgZXh0ZW5kcyBEZWNvZGVyUHJvdG90eXBhbFRhcmdldD4odGFyZ2V0OiBUKTogVCA9PiB7XG4gICAgICAgIGRlYnVnKGAke3RhcmdldC5uYW1lfSBhcHBseWluZyBqc29uU2NoZW1hYClcbiAgICAgICAgY29uc3Qgc2NoZW1hTWV0YWRhdGE6IEpzb25EZWNvZGVyU2NoZW1hTWV0YWRhdGEgPSB7XG4gICAgICAgICAgICBzY2hlbWEsXG4gICAgICAgICAgICByZWZlcmVuY2VzLFxuICAgICAgICB9XG4gICAgICAgIFJlZmxlY3QuZGVmaW5lTWV0YWRhdGEoSnNvbkRlY29kZXJNZXRhZGF0YUtleXMuc2NoZW1hLCBzY2hlbWFNZXRhZGF0YSwgdGFyZ2V0KVxuXG4gICAgICAgIHJldHVybiB0YXJnZXRcbiAgICB9XG59XG5cbi8vXG4vLyBQcm9wZXJ0eSBkZWNvcmF0b3JzXG4vL1xuXG4vKipcbiAqIEpTT04gY29udGV4dCBvYmplY3QgKHRoZSBvcmlnaW4gSlNPTikgYXNzaWduZWQgdG8gZGVjb2Rpbmcgb2JqZWN0XG4gKiBBbHNvIGFkZGVzIGB0b0pTT04oKWAgdG8gcmV0dXJuIHRoZSBkZWNvZGVkIG9iamVjdCBiYWNrXG4gKlxuICogQGV4YW1wbGVcbiAqICAgLy8gU2V0cyB0aGUgb3JpZ2luIEpTT04gdG8gYSBkZXNpZ25hdGVkIGNvbnRleHQgcHJvcGVydHlcbiAqICAgQGpzb25Db250ZXh0XG4gKiAgIHByaXZhdGUganNvbjogSnNvbk9iamVjdFxuICovXG5leHBvcnQgZnVuY3Rpb24ganNvbkNvbnRleHQ8VCBleHRlbmRzIERlY29kZXJDb25zdHJ1Y3RhYmxlVGFyZ2V0Pih0YXJnZXQ6IFQsIGtleTogc3RyaW5nKSB7XG4gICAgZGVidWcoYCR7dGFyZ2V0LmNvbnN0cnVjdG9yLm5hbWV9IGFwcGx5aW5nIGpzb25Db250ZXh0IHRvICR7a2V5fWApXG4gICAgUmVmbGVjdC5kZWZpbmVNZXRhZGF0YShKc29uRGVjb2Rlck1ldGFkYXRhS2V5cy5jb250ZXh0LCBrZXksIHRhcmdldC5jb25zdHJ1Y3RvcilcblxuICAgIGNvbnN0IGRlc2NyaXB0b3IgPSBSZWZsZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSlcbiAgICBSZWZsZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCB7XG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgd3JpdGFibGU6IHRydWUsXG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICB2YWx1ZTogISFkZXNjcmlwdG9yID8gZGVzY3JpcHRvci52YWx1ZSA6IHVuZGVmaW5lZCxcbiAgICB9KVxuXG4gICAgLy8gZGVmaW5lZCB0b0pTT04gaWYgbm90IGFscmVhZHkgZGVmaW5lZFxuICAgIGlmICghKCd0b0pTT04nIGluIHRhcmdldCkpIHtcbiAgICAgICAgdGFyZ2V0Wyd0b0pTT04nXSA9IGZ1bmN0aW9uIHRvSlNPTigpIHtcbiAgICAgICAgICAgIHJldHVybiB7Li4udGhpc1trZXldfVxuICAgICAgICB9XG4gICAgfVxufVxuXG4vKipcbiAqIERlY2xhcmVzIGEgSlNPTiBkZWNvZGFibGUgcHJvcGVydHlcbiAqXG4gKiBAZXhhbXBsZVxuICogICAvLyBVc2VzICdpbmRleCcgZnJvbSBKU09OXG4gKiAgIEBqc29uUHJvcGVydHkoKVxuICogICBwcml2YXRlIGluZGV4OiBudW1iZXJcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGpzb25Qcm9wZXJ0eTxUIGV4dGVuZHMgRGVjb2RlckNvbnN0cnVjdGFibGVUYXJnZXQ+KHRhcmdldDogVCwga2V5OiBzdHJpbmcpIHtcbiAgICBkZWJ1ZyhgJHt0YXJnZXQuY29uc3RydWN0b3IubmFtZX0gYXBwbHlpbmcganNvblByb3BlcnR5IHRvICR7a2V5fWApXG5cbiAgICBjb25zdCBkZWNvZGVyTWFwID0gZGVjb2Rlck1hcEVudHJ5Rm9yVGFyZ2V0KGtleSwgdGFyZ2V0LmNvbnN0cnVjdG9yKTtcbiAgICBpZiAodHlwZW9mIGRlY29kZXJNYXAua2V5ICE9PSAnc3RyaW5nJyB8fCBkZWNvZGVyTWFwLmtleS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgZGVjb2Rlck1hcC5rZXkgPSBrZXlcbiAgICB9XG59XG5cbi8qKlxuICogRGVjbGFyZXMgYSBKU09OIGRlY29kYWJsZSBwcm9wZXJ0eSB3aXRoIG9wdGlvbmFsIGtleS9rZXktcGF0aCBhbGlhc1xuICpcbiAqIEBleGFtcGxlXG4gKiAgIC8vIFVzZXMgJ2luZGV4JyBmcm9tIEpTT04sIGFzc2lnbmVkIHRvICdfaW5kZXgnXG4gKiAgIEBqc29uUGF0aCgnaW5kZXgnKVxuICogICBwcml2YXRlIF9pbmRleDogbnVtYmVyXG4gKlxuICogICAvLyBVc2VzICdpbmRleGVzJyBmcm9tIEpTT04sIHRha2luZyB0aGUgYXJyYXkgdmFsdWUncyAwIGluZGV4XG4gKiAgIEBqc29uUGF0aCgnaW5kZXhlc1swXScpIC0gb3IgLSBAanNvblBhdGgoJ2luZGV4ZXNAMCcpXG4gKiAgIHByaXZhdGUgaW5kZXg6IG51bWJlclxuICpcbiAqICAgLy8gVXNlcyAndGFyZ2V0OiB7IGluZGV4IH0nIGZyb20gSlNPTlxuICogICBAanNvblBhdGgoJ3RhcmdldC5pbmRleCcpXG4gKiAgIHByaXZhdGUgaW5kZXg6IG51bWJlclxuICpcbiAqIEBwYXJhbSBrZXlQYXRoIC0gcGF0aCB0byB0aGUgcHJvcGVydHksIG9yIHVuZGVmaW5lZCB0byB1c2UgcHJvcGVydHkgbmFtZVxuICovXG5leHBvcnQgZnVuY3Rpb24ganNvblByb3BlcnR5QWxpYXMoa2V5UGF0aDogc3RyaW5nKSB7XG4gICAgaWYgKHR5cGVvZiBrZXlQYXRoICE9PSAnc3RyaW5nJyB8fCBrZXlQYXRoLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdqc29uUHJvcGVydHkoa2V5UGF0aCkgc2hvdWxkIGJlIGEgbm9uLWVtcHR5IFN0cmluZycpXG4gICAgfVxuXG4gICAgcmV0dXJuICh0YXJnZXQ6IERlY29kZXJDb25zdHJ1Y3RhYmxlVGFyZ2V0LCBrZXk6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBkZWNvZGVyTWFwID0gZGVjb2Rlck1hcEVudHJ5Rm9yVGFyZ2V0KGtleSwgdGFyZ2V0LmNvbnN0cnVjdG9yKTtcbiAgICAgICAgaWYgKGtleVBhdGgpIHtcbiAgICAgICAgICAgIC8vIFRPRE86IENvbXBpbGUgdGhlIHBhdGggaGVyZSBpbnN0ZWFkIG9mIGVhY2ggZGVjb2RlXG4gICAgICAgICAgICBkZWNvZGVyTWFwLmtleSA9IGtleVBhdGhcbiAgICAgICAgfVxuICAgIH1cbn1cblxuLyoqXG4gKiBBdXRvbWF0aWNhbGx5IG1hcHMgKG1hcnNoYWxzKSBhIHZhbHVlIGZyb20gYSBKU09OIHByb3BlcnR5IHZhbHVlIGludG8gYSBkZXNpcmVkIHR5cGVcbiAqXG4gKiBAZXhhbXBsZVxuICogICAvLyBFbnN1cmVzIGEgTnVtYmVyIHZhbHVlIHdpbGwgYmUgYXNzaWduZWQgdG8gJ2luZGV4JywgbWFwcGVkIGFwcHJvcHJpYXRlbHlcbiAqICAgQGpzb25Qcm9wZXJ0eSgpXG4gKiAgIEBqc29uVHlwZShOdW1iZXIpXG4gKiAgIHByaXZhdGUgaW5kZXg6IG51bWJlclxuICpcbiAqICAgLy8gRW5zdXJlcyBhIFVSTCB2YWx1ZSB3aWxsIGJlIGFzc2lnbmVkIHRvICdlbmRwb2ludCcsIG1hcnNoYWxsZWQgZnJvbSBhIHN0cmluZyBhcHByb3ByaWF0ZWx5XG4gKiAgIEBqc29uUHJvcGVydHkoKVxuICogICBAanNvblR5cGUoVVJMKVxuICogICBwcml2YXRlIGluZGV4OiBVUkxcbiAqXG4gKiAgIC8vIEVuc3VyZXMgdGhlIGRlY29kZWQgdmFsdWUgd2lsbCBiZSBhIHN0cmluZywgYW5kIHVzZXMgdGhlIHN0cmluZyB3aXRoIGEgY3VzdG9tIG1hcCBmdW5jdGlvblxuICogICBAanNvblByb3BlcnR5KClcbiAqICAgQGpzb25UeXBlKFN0cmluZywgKHZhbHVlOiBzdHJpbmcpID0+IG5ldyBSZWdFeC5jb21waWxlKHZhbHVlKSlcbiAqICAgcHJpdmF0ZSBwYXR0ZXJuOiBSZWdFeFxuICpcbiAqIEBwYXJhbSB0eXBlIC0gbWFyc2hhbGxhYmxlIHR5cGVcbiAqIEBwYXJhbSBbbWFwRnVuY3Rpb25dIC0gb3B0aW9uYWwgZnVuY3Rpb24gdGFraW5nIGFuIGluc3RhbmNlIG9mIGB0eXBlYFxuICovXG5leHBvcnQgZnVuY3Rpb24ganNvblR5cGUoXG4gICAgdHlwZTogRGVjb2RlclByb3RvdHlwYWxUYXJnZXQgfCBEZWNvZGVyUHJvdG90eXBhbENvbGxlY3Rpb25UYXJnZXQsXG4gICAgbWFwRnVuY3Rpb24/OiAodmFsdWU6IGFueSkgPT4gYW55LFxuKSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkodHlwZSkgJiYgdHlwZS5sZW5ndGggIT09IDEpIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignanNvblR5cGUodHlwZSkgc2hvdWxkIGhhdmUgZXhhY3RseSBvbmUgZWxlbWVudCBmb3IgQXJyYXkgdHlwZXMnKVxuICAgIH1cblxuICAgIHJldHVybiAodGFyZ2V0OiBEZWNvZGVyQ29uc3RydWN0YWJsZVRhcmdldCwga2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgZGVjb2Rlck1hcEVudHJ5ID0gZGVjb2Rlck1hcEVudHJ5Rm9yVGFyZ2V0KGtleSwgdGFyZ2V0LmNvbnN0cnVjdG9yKVxuXG4gICAgICAgIGNvbnN0IGVsZW1lbnRUeXBlID0gaXNEZWNvZGVyUHJvdG90eXBhbENvbGxlY3Rpb25UYXJnZXQodHlwZSkgPyB0eXBlLmNvbGxlY3Rpb24gOiB0eXBlXG4gICAgICAgIGRlYnVnKGAke3RhcmdldC5jb25zdHJ1Y3Rvci5uYW1lfSBhcHBseWluZyBqc29uVHlwZSB0byAke2tleX0sIG1hcnNoYWxsaW5nIHVzaW5nICR7ZWxlbWVudFR5cGUubmFtZX1gKVxuXG4gICAgICAgIGRlY29kZXJNYXBFbnRyeS50eXBlID0gdHlwZVxuICAgICAgICBkZWNvZGVyTWFwRW50cnkubWFwRnVuY3Rpb24gPSBtYXBGdW5jdGlvblxuICAgIH1cbn1cblxuLy9cbi8vIEZ1bmN0aW9uIGRlY29yYXRvcnNcbi8vXG5cbi8qKlxuICogRGVjbGFyZXMgYSBmdW5jdGlvbiBhcyBiZWluZyB0aGUgZGVjb2RlciBjbGFzcyBmYWN0b3J5LCByZXR1cm5pbmcgdGhlIGNsYXNzIHRvIGluc3RhdGlhdGUgd2l0aCB0aGUgSlNPTiBkZWNvZGVyXG4gKlxuICogQGV4YW1wbGVcbiAqICAgQGpzb25EZWNvZGVyRmFjdG9yeVxuICogICBzdGF0aWMgZGVjb2RlckNsYXNzRmFjdG9yeShqc29uOiBKc29uT2JqZWN0KSB7XG4gKiAgICAgICAvLyBJZiAndHlwZScgaXMgJ3NwZWNpYWwnIGluIG91ciBKU09OIG9iamVjdCwgcmV0dXJuIE15U3BlY2lhbENsYXNzIHRvIGRlY29kZVxuICogICAgICAgaWYgKCd0eXBlJyBpbiBqc29uICYmIGpzb24udHlwZSA9PT0gJ3NwZWNpYWwnKSB7XG4gKiAgICAgICAgICAgcmV0dXJuIG5ldyBNeVNwZWNpYWxDbGFzcygpXG4gKiAgICAgICB9XG4gKlxuICogICAgICAgcmV0dXJuIE15Q2xhc3MoKVxuICogICB9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBqc29uRGVjb2RlckZhY3RvcnkodGFyZ2V0OiBEZWNvZGVyUHJvdG90eXBhbFRhcmdldCwga2V5OiBzdHJpbmcsIGRlc2NyaXB0b3I6IFByb3BlcnR5RGVzY3JpcHRvcik6IFByb3BlcnR5RGVzY3JpcHRvciB7XG4gICAgZGVidWcoYCR7dGFyZ2V0Lm5hbWV9IGFwcGx5aW5nIGpzb25EZWNvZGVyRmFjdG9yeSB0byAke2tleX1gKVxuICAgIFJlZmxlY3QuZGVmaW5lTWV0YWRhdGEoRGVjb2Rlck1ldGFkYXRhS2V5cy5kZWNvZGVyRmFjdG9yeSwgdGFyZ2V0W2tleV0sIHRhcmdldClcblxuICAgIHJldHVybiBkZXNjcmlwdG9yXG59XG5cbi8qKlxuICogU3BlY2lmaWVzIHRoZSBkZWNvZGVyIGZ1bmN0aW9uLiBUaGlzIGRlY29yYXRpb24gYmVoYXZlcyBkaWZmZXJlbnRseSBkZXBlbmRpbmcgb24gdGhlIHBsYWNlbWVudCBvbiB0aGVcbiAqIGNsYXNzKHN0YXRpYyBmdW5jdGlvbikvY29uc3RydWN0b3IgZnVuY3Rpb24gaXRzZWxmLCBvciBvbiB0aGUgY2xhc3MgcHJvdG90eXBlLiBCb3RoIG1heSBiZSB1c2VkLCBpZiBkZXNpcmVkLlxuICogSW4gYm90aCBjYXNlIHRoZSBzb3VyY2UgSlNPTiBvYmplY3Qgd2lsbCBiZSBzdXBwbGllZCB0byBhaWQgZGVjb2RpbmcuXG4gKlxuICogV2hlbiBhcHBsaWVkIHRvIHRoZSBjbGFzcyAoc3RhdGljIGZ1bmN0aW9uKSB0aGUgZGVjb2RlciBmdW5jdGlvbiBtdXN0IHJldHVybiB0aGUgZGVjb2RlZCBvYmplY3QsIG9yIGluaXRpYWxpemVcbiAqIGFuZCBvYmplY3QgdG8gYmVnaW4gZGVjb2RpbmcuIFJldHVybmluZyB1bmRlZmluZWQgd2lsbCBmYWxsYmFjayB0byB0aGUgZGVmYXVsdCBvYmplY3QgY3JlYXRpb24sIHJldHVybmluZyBudWxsIHdpbGxcbiAqIGludmFsaWRhdGUgZGVjb2RpbmcuXG4gKlxuICogV2hlbiBhcHBsaWVkIHRvIGEgcHJvdG90eXBlIGZ1bmN0aW9uLCB0aGUgZGVjb2Rpbmcgb2JqZWN0IHdpbGwgaGF2ZSBiZWVuIGNyZWF0ZWQuIFRoZSBmdW5jdGlvbiBtdXN0IHJldHVybiB0aGlzIG9yXG4gKiBhIHJlcGxhY2VtZW50IG9iamVjdC4gUmV0dXJuaW5nIHVuZGVmaW5lZCB3aWxsIGZhbGxiYWNrIGFuZCB1c2UgdGhlIHNhbWUgZGVjb2Rpbmcgb2JqZWN0IGFscmVhZHkgY3JlYXRlZCwgcmV0dXJuaW5nXG4gKiBudWxsbCB3aWxsIGludmFsaWRhdGUgdGhlIGRlY29kaW5nLlxuICpcbiAqIEVycm9ycyB0aHJvd24gaGVyZSB3aWxsIGJlIHByb3BhZ2F0ZWRcbiAqXG4gKiBAZXhhbXBsZVxuICogICBAanNvbkRlY29kZXJcbiAqICAgcHVibGljIGRlY29kZXIoanNvbjogT2JqZWN0KTogTXlDbGFzcyB8IG51bGwgeyAuLi4gfVxuICovXG5leHBvcnQgZnVuY3Rpb24ganNvbkRlY29kZXIodGFyZ2V0OiBEZWNvZGVyQ29uc3RydWN0YWJsZVRhcmdldCwga2V5OiBzdHJpbmcsIGRlc2NyaXB0b3I6IFByb3BlcnR5RGVzY3JpcHRvcik6IFByb3BlcnR5RGVzY3JpcHRvciB7XG4gICAgZGVidWcoYCR7dGFyZ2V0LmNvbnN0cnVjdG9yLm5hbWV9IGFwcGx5aW5nIGpzb25EZWNvZGVyIHRvICR7a2V5fWApXG4gICAgUmVmbGVjdC5kZWZpbmVNZXRhZGF0YShEZWNvZGVyTWV0YWRhdGFLZXlzLmRlY29kZXIsIHRhcmdldFtrZXldLCB0YXJnZXQpXG5cbiAgICByZXR1cm4gZGVzY3JpcHRvclxufVxuXG4vKipcbiAqIFNwZWNpZmllcyB0aGUgZnVuY3Rpb24gY2FsbGVkIG9uIHRoZSBkZWNvZGVkIG9iamVjdCB3aGVuIGRlY29kaW5nIGhhcyBjb21wbGV0ZWQuIEF0IHRoaXMgcG9pbnQgYWxsIHByb3BlcnRpZXMgaGF2ZVxuICogYmVlbiBhc3NpZ25lZCwgYW5kIGFsbCBwcm9wZXJ0eSBoYW5kbGVyIGZ1bmN0aW9ucyBjYWxsZWQuIGBqc29uRGVjb2RlckNvbXBsZXRlZGAgb25seSBjYW4gYmUgY2FsbGVkIG9uIHByb3RvdHlwZVxuICogZnVuY3Rpb25zLCBhbmQgcHJvdmlkZXMgYSBsYXN0IGNoYW5jZSB0byBwZXJmb3JtIGFueSBhZGRpdGlvbmFsIGRlY29kaW5nLCB2YWxpZGF0aW9uLCBvciBpbnZhbGlkYXRpb24uXG4gKlxuICogTGlrZSBganNvbkRlY29kZXJgIHJldHVybmluZyBgbnVsbGAgaW52YWxpZGF0ZXMgdGhlIGRlY29kZWQgb2JqZWN0LlxuICpcbiAqIEVycm9ycyB0aHJvd24gaGVyZSB3aWxsIGJlIHByb3BhZ2F0ZWRcbiAqXG4gKiBAZXhhbXBsZVxuICogICBAanNvbkRlY29kZXJDb21wbGV0ZVxuICogICBmdW5jdGlvbiBkZWNvZGVyKGpzb246IE9iamVjdCk6IE15Q2xhc3MgfCBudWxsIHsgLi4uIH1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGpzb25EZWNvZGVyQ29tcGxldGVkKHRhcmdldDogRGVjb2RlckNvbnN0cnVjdGFibGVUYXJnZXQsIGtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3IpOiBQcm9wZXJ0eURlc2NyaXB0b3Ige1xuICAgIGRlYnVnKGAke3RhcmdldC5jb25zdHJ1Y3Rvci5uYW1lfSBhcHBseWluZyBqc29uRGVjb2RlckNvbXBsZXRlZCB0byAke2tleX1gKVxuICAgIFJlZmxlY3QuZGVmaW5lTWV0YWRhdGEoRGVjb2Rlck1ldGFkYXRhS2V5cy5kZWNvZGVyQ29tcGxldGVkLCB0YXJnZXRba2V5XSwgdGFyZ2V0KVxuXG4gICAgcmV0dXJuIGRlc2NyaXB0b3Jcbn1cblxuLyoqXG4gKiBBc3NvY2lhdGVzIGEgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gYSBKU09OIHByb3BlcnR5IG9mIGEgZ2l2ZW4ga2V5IHBhdGggaXMgZm91bmQuXG4gKlxuICogQGV4YW1wbGVcbiAqICAganNvbk5vdGlmeSgnaW5kZXgnLCBOdW1iZXIpXG4gKiAgIHByaXZhdGUgb25JbmRleChpbmRleDogbnVtYmVyLCBqc29uOiBKc29uT2JqZWN0KSB7XG4gKiAgICAgLy8gRG8gc29tZXRoaW5nIHdpdGggaW5kZXhcbiAqICAgICAvLyAndGhpcycgaXMgc2V0IHRvIHRoZSBvYmplY3QgYmVpbmcgY29kZWRcbiAqICAgfVxuICpcbiAqIEBwYXJhbSBrZXlQYXRoIC0ga2V5IHBhdGggdG8gdGhlIHByb3BlcnR5IGZyb20gdGhlIHJvb3QgZm9yIHRoZSBKU09OXG4gKiBAcGFyYW0gW3R5cGU9dW5kZWZpbmVkXSAtIHR5cGUgZGVjbGFyYXRpb24gc2ltaWxhciB0byBqc29uVHlwZSB0byBhdXRvbWF0aWNhbGx5IG1hcCB0aGUgcHJvcGVydHkgdG9cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGpzb25Ob3RpZnkoa2V5UGF0aDogc3RyaW5nLCB0eXBlPzogRGVjb2RlclByb3RvdHlwYWxUYXJnZXQgfCBEZWNvZGVyUHJvdG90eXBhbENvbGxlY3Rpb25UYXJnZXQpIHtcbiAgICBpZiAodHlwZW9mIGtleVBhdGggIT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2pzb25Qcm9wZXJ0eUhhbmRsZXIoa2V5UGF0aCkgc2hvdWxkIGJlIGEgbm9uLWVtcHR5IFN0cmluZycpXG4gICAgfVxuICAgIGlmIChBcnJheS5pc0FycmF5KHR5cGUpICYmIHR5cGUubGVuZ3RoICE9PSAxKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2pzb25Qcm9wZXJ0eUhhbmRsZXIodHlwZSkgc2hvdWxkIGhhdmUgZXhhY3RseSBvbmUgZWxlbWVudCBmb3IgQXJyYXkgdHlwZXMnKVxuICAgIH1cblxuICAgIHJldHVybiA8VCBleHRlbmRzIERlY29kZXJDb25zdHJ1Y3RhYmxlVGFyZ2V0Pih0YXJnZXQ6IFQsIGtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3IpOiBQcm9wZXJ0eURlc2NyaXB0b3IgPT4ge1xuICAgICAgICBkZWJ1ZyhgJHt0YXJnZXQuY29uc3RydWN0b3IubmFtZX0gYXBwbHlpbmcganNvblByb3BlcnR5SGFuZGxlciAke2tleVBhdGh9IHRvICR7a2V5fWApXG5cbiAgICAgICAgbGV0IG5vdGlmaWVyczogTWFwPHN0cmluZywgRGVjb2Rlck1hcEVudHJ5W10+ID0gUmVmbGVjdC5nZXRPd25NZXRhZGF0YShcbiAgICAgICAgICAgIERlY29kZXJNZXRhZGF0YUtleXMuZGVjb2Rlck5vdGlmaWVycyxcbiAgICAgICAgICAgIHRhcmdldC5jb25zdHJ1Y3RvcixcbiAgICAgICAgKVxuICAgICAgICBpZiAoIW5vdGlmaWVycykge1xuICAgICAgICAgICAgbm90aWZpZXJzID0gbmV3IE1hcCgpXG4gICAgICAgICAgICBSZWZsZWN0LmRlZmluZU1ldGFkYXRhKERlY29kZXJNZXRhZGF0YUtleXMuZGVjb2Rlck5vdGlmaWVycywgbm90aWZpZXJzLCB0YXJnZXQuY29uc3RydWN0b3IpXG4gICAgICAgIH1cbiAgICAgICAgbGV0IHByb3BlcnR5Tm90aWZpZXJzID0gbm90aWZpZXJzLmdldChrZXlQYXRoKVxuICAgICAgICBpZiAoIXByb3BlcnR5Tm90aWZpZXJzKSB7XG4gICAgICAgICAgICBwcm9wZXJ0eU5vdGlmaWVycyA9IFtdXG4gICAgICAgICAgICBub3RpZmllcnMuc2V0KGtleVBhdGgsIHByb3BlcnR5Tm90aWZpZXJzKVxuICAgICAgICB9XG4gICAgICAgIHByb3BlcnR5Tm90aWZpZXJzLnB1c2goe1xuICAgICAgICAgICAga2V5OiBrZXlQYXRoLFxuICAgICAgICAgICAgdHlwZSxcbiAgICAgICAgICAgIG1hcEZ1bmN0aW9uOiBkZXNjcmlwdG9yLnZhbHVlLFxuICAgICAgICB9KVxuXG4gICAgICAgIHJldHVybiBkZXNjcmlwdG9yXG4gICAgfVxufVxuIl19