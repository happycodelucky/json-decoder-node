"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("reflect-metadata");
const createDebugLog = require("debug");
const decoder_declarations_1 = require("../decoder/decoder-declarations");
const decoder_declarations_2 = require("../decoder/decoder-declarations");
const decoder_map_1 = require("../decoder/decoder-map");
const json_symbols_1 = require("./json-symbols");
const debug = createDebugLog('decoder:json');
function jsonDecodable(options) {
    return (target) => {
        debug(`${target.name} applying jsonDecodable with options ${JSON.stringify(options)}`);
        Reflect.defineMetadata(decoder_declarations_1.DecoderMetadataKeys.decodable, true, target);
        const decodableOptions = Object.assign({}, options);
        Reflect.defineMetadata(decoder_declarations_1.DecoderMetadataKeys.decodableOptions, decodableOptions, target);
        return target;
    };
}
exports.jsonDecodable = jsonDecodable;
function jsonSchema(schema, ...references) {
    return (target) => {
        debug(`${target.name} applying jsonSchema`);
        const schemaMetadata = {
            schema,
            references,
        };
        Reflect.defineMetadata(json_symbols_1.JsonDecoderMetadataKeys.schema, schemaMetadata, target);
        return target;
    };
}
exports.jsonSchema = jsonSchema;
function jsonContext(target, key) {
    debug(`${target.constructor.name} applying jsonContext to ${key}`);
    Reflect.defineMetadata(json_symbols_1.JsonDecoderMetadataKeys.context, key, target.constructor);
    const descriptor = Reflect.getOwnPropertyDescriptor(target, key);
    Reflect.defineProperty(target, key, {
        configurable: true,
        writable: true,
        enumerable: false,
        value: !!descriptor ? descriptor.value : undefined,
    });
    if (!('toJSON' in target)) {
        target['toJSON'] = function toJSON() {
            return Object.assign({}, this[key]);
        };
    }
}
exports.jsonContext = jsonContext;
function jsonProperty(target, key) {
    debug(`${target.constructor.name} applying jsonProperty to ${key}`);
    const decoderMap = decoder_map_1.decoderMapEntryForTarget(key, target.constructor);
    if (typeof decoderMap.key !== 'string' || decoderMap.key.length === 0) {
        decoderMap.key = key;
    }
}
exports.jsonProperty = jsonProperty;
function jsonPropertyAlias(keyPath) {
    if (typeof keyPath !== 'string' || keyPath.length === 0) {
        throw new TypeError('jsonProperty(keyPath) should be a non-empty String');
    }
    return (target, key) => {
        const decoderMap = decoder_map_1.decoderMapEntryForTarget(key, target.constructor);
        decoderMap.key = keyPath;
    };
}
exports.jsonPropertyAlias = jsonPropertyAlias;
function jsonType(type, mapFunction) {
    if (Array.isArray(type) && type.length !== 1) {
        throw new TypeError('jsonType(type) should have exactly one element for Array types');
    }
    return (target, key) => {
        const decoderMapEntry = decoder_map_1.decoderMapEntryForTarget(key, target.constructor);
        const elementType = decoder_declarations_2.isDecoderPrototypalCollectionTarget(type) ? type.collection : type;
        debug(`${target.constructor.name} applying jsonType to ${key}, marshalling using ${elementType.name}`);
        decoderMapEntry.type = type;
        decoderMapEntry.mapFunction = mapFunction;
    };
}
exports.jsonType = jsonType;
function jsonDecoderFactory(target, key, descriptor) {
    debug(`${target.name} applying jsonDecoderFactory to ${key}`);
    Reflect.defineMetadata(decoder_declarations_1.DecoderMetadataKeys.decoderFactory, target[key], target);
    return descriptor;
}
exports.jsonDecoderFactory = jsonDecoderFactory;
function jsonDecoder(target, key, descriptor) {
    debug(`${target.constructor.name} applying jsonDecoder to ${key}`);
    Reflect.defineMetadata(decoder_declarations_1.DecoderMetadataKeys.decoder, target[key], target);
    return descriptor;
}
exports.jsonDecoder = jsonDecoder;
function jsonDecoderCompleted(target, key, descriptor) {
    debug(`${target.constructor.name} applying jsonDecoderCompleted to ${key}`);
    Reflect.defineMetadata(decoder_declarations_1.DecoderMetadataKeys.decoderCompleted, target[key], target);
    return descriptor;
}
exports.jsonDecoderCompleted = jsonDecoderCompleted;
function jsonNotify(keyPath, type) {
    if (typeof keyPath !== 'string') {
        throw new TypeError('jsonPropertyHandler(keyPath) should be a non-empty String');
    }
    if (Array.isArray(type) && type.length !== 1) {
        throw new TypeError('jsonPropertyHandler(type) should have exactly one element for Array types');
    }
    return (target, key, descriptor) => {
        debug(`${target.constructor.name} applying jsonPropertyHandler ${keyPath} to ${key}`);
        let notifiers = Reflect.getOwnMetadata(decoder_declarations_1.DecoderMetadataKeys.decoderNotifiers, target.constructor);
        if (!notifiers) {
            notifiers = new Map();
            Reflect.defineMetadata(decoder_declarations_1.DecoderMetadataKeys.decoderNotifiers, notifiers, target.constructor);
        }
        let propertyNotifiers = notifiers.get(keyPath);
        if (!propertyNotifiers) {
            propertyNotifiers = [];
            notifiers.set(keyPath, propertyNotifiers);
        }
        propertyNotifiers.push({
            key: keyPath,
            type,
            mapFunction: descriptor.value,
        });
        return descriptor;
    };
}
exports.jsonNotify = jsonNotify;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianNvbi1kZWNvcmF0b3JzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2pzb24vanNvbi1kZWNvcmF0b3JzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBSUEsNEJBQXlCO0FBRXpCLHdDQUF1QztBQUV2QywwRUFBMEg7QUFDMUgsMEVBQXdIO0FBQ3hILHdEQUFrRjtBQUVsRixpREFBd0Q7QUFHeEQsTUFBTSxLQUFLLEdBQUcsY0FBYyxDQUFDLGNBQWMsQ0FBQyxDQUFBO0FBMkI1QyxTQUFnQixhQUFhLENBQUMsT0FBOEI7SUFDeEQsT0FBTyxDQUFvQyxNQUFTLEVBQXVCLEVBQUU7UUFDekUsS0FBSyxDQUFDLEdBQUcsTUFBTSxDQUFDLElBQUksd0NBQXdDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQ3RGLE9BQU8sQ0FBQyxjQUFjLENBQUMsMENBQW1CLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQTtRQUduRSxNQUFNLGdCQUFnQixxQkFBNkIsT0FBTyxDQUFDLENBQUE7UUFDM0QsT0FBTyxDQUFDLGNBQWMsQ0FBQywwQ0FBbUIsQ0FBQyxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLENBQUMsQ0FBQTtRQUt0RixPQUE2QixNQUFNLENBQUE7SUFDdkMsQ0FBQyxDQUFBO0FBQ0wsQ0FBQztBQWRELHNDQWNDO0FBMEJELFNBQWdCLFVBQVUsQ0FBQyxNQUEyQixFQUFFLEdBQUcsVUFBNkQ7SUFDcEgsT0FBTyxDQUFvQyxNQUFTLEVBQUssRUFBRTtRQUN2RCxLQUFLLENBQUMsR0FBRyxNQUFNLENBQUMsSUFBSSxzQkFBc0IsQ0FBQyxDQUFBO1FBQzNDLE1BQU0sY0FBYyxHQUE4QjtZQUM5QyxNQUFNO1lBQ04sVUFBVTtTQUNiLENBQUE7UUFDRCxPQUFPLENBQUMsY0FBYyxDQUFDLHNDQUF1QixDQUFDLE1BQU0sRUFBRSxjQUFjLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFFOUUsT0FBTyxNQUFNLENBQUE7SUFDakIsQ0FBQyxDQUFBO0FBQ0wsQ0FBQztBQVhELGdDQVdDO0FBZUQsU0FBZ0IsV0FBVyxDQUFrRSxNQUFTLEVBQUUsR0FBVztJQUMvRyxLQUFLLENBQUMsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksNEJBQTRCLEdBQUcsRUFBRSxDQUFDLENBQUE7SUFDbEUsT0FBTyxDQUFDLGNBQWMsQ0FBQyxzQ0FBdUIsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQTtJQUVoRixNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsd0JBQXdCLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBQ2hFLE9BQU8sQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRTtRQUNoQyxZQUFZLEVBQUUsSUFBSTtRQUNsQixRQUFRLEVBQUUsSUFBSTtRQUNkLFVBQVUsRUFBRSxLQUFLO1FBQ2pCLEtBQUssRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFTO0tBQ3JELENBQUMsQ0FBQTtJQUdGLElBQUksQ0FBQyxDQUFDLFFBQVEsSUFBSSxNQUFNLENBQUMsRUFBRTtRQUN2QixNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsU0FBUyxNQUFNO1lBQzlCLHlCQUFXLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBQztRQUN6QixDQUFDLENBQUE7S0FDSjtBQUNMLENBQUM7QUFsQkQsa0NBa0JDO0FBVUQsU0FBZ0IsWUFBWSxDQUF1QyxNQUFTLEVBQUUsR0FBVztJQUNyRixLQUFLLENBQUMsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksNkJBQTZCLEdBQUcsRUFBRSxDQUFDLENBQUE7SUFFbkUsTUFBTSxVQUFVLEdBQUcsc0NBQXdCLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNyRSxJQUFJLE9BQU8sVUFBVSxDQUFDLEdBQUcsS0FBSyxRQUFRLElBQUksVUFBVSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1FBQ25FLFVBQVUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFBO0tBQ3ZCO0FBQ0wsQ0FBQztBQVBELG9DQU9DO0FBb0JELFNBQWdCLGlCQUFpQixDQUFDLE9BQWU7SUFDN0MsSUFBSSxPQUFPLE9BQU8sS0FBSyxRQUFRLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDckQsTUFBTSxJQUFJLFNBQVMsQ0FBQyxvREFBb0QsQ0FBQyxDQUFBO0tBQzVFO0lBRUQsT0FBTyxDQUFDLE1BQWtDLEVBQUUsR0FBVyxFQUFFLEVBQUU7UUFDdkQsTUFBTSxVQUFVLEdBQUcsc0NBQXdCLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUVwRSxVQUFVLENBQUMsR0FBRyxHQUFHLE9BQU8sQ0FBQTtJQUM1QixDQUFDLENBQUE7QUFDTCxDQUFDO0FBVkQsOENBVUM7QUF3QkQsU0FBZ0IsUUFBUSxDQUNwQixJQUFpRSxFQUNqRSxXQUFpQztJQUVqQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDMUMsTUFBTSxJQUFJLFNBQVMsQ0FBQyxnRUFBZ0UsQ0FBQyxDQUFBO0tBQ3hGO0lBRUQsT0FBTyxDQUFDLE1BQWtDLEVBQUUsR0FBVyxFQUFFLEVBQUU7UUFDdkQsTUFBTSxlQUFlLEdBQUcsc0NBQXdCLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUV6RSxNQUFNLFdBQVcsR0FBRywwREFBbUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFBO1FBQ3RGLEtBQUssQ0FBQyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSx5QkFBeUIsR0FBRyx1QkFBdUIsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUE7UUFFdEcsZUFBZSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUE7UUFDM0IsZUFBZSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUE7SUFDN0MsQ0FBQyxDQUFBO0FBQ0wsQ0FBQztBQWpCRCw0QkFpQkM7QUFvQkQsU0FBZ0Isa0JBQWtCLENBQUMsTUFBK0IsRUFBRSxHQUFXLEVBQUUsVUFBOEI7SUFDM0csS0FBSyxDQUFDLEdBQUcsTUFBTSxDQUFDLElBQUksbUNBQW1DLEdBQUcsRUFBRSxDQUFDLENBQUE7SUFDN0QsT0FBTyxDQUFDLGNBQWMsQ0FBQywwQ0FBbUIsQ0FBQyxjQUFjLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFBO0lBRS9FLE9BQU8sVUFBVSxDQUFBO0FBQ3JCLENBQUM7QUFMRCxnREFLQztBQXFCRCxTQUFnQixXQUFXLENBQUMsTUFBa0MsRUFBRSxHQUFXLEVBQUUsVUFBOEI7SUFDdkcsS0FBSyxDQUFDLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLDRCQUE0QixHQUFHLEVBQUUsQ0FBQyxDQUFBO0lBQ2xFLE9BQU8sQ0FBQyxjQUFjLENBQUMsMENBQW1CLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQTtJQUV4RSxPQUFPLFVBQVUsQ0FBQTtBQUNyQixDQUFDO0FBTEQsa0NBS0M7QUFlRCxTQUFnQixvQkFBb0IsQ0FBQyxNQUFrQyxFQUFFLEdBQVcsRUFBRSxVQUE4QjtJQUNoSCxLQUFLLENBQUMsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUkscUNBQXFDLEdBQUcsRUFBRSxDQUFDLENBQUE7SUFDM0UsT0FBTyxDQUFDLGNBQWMsQ0FBQywwQ0FBbUIsQ0FBQyxnQkFBZ0IsRUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFFakYsT0FBTyxVQUFVLENBQUE7QUFDckIsQ0FBQztBQUxELG9EQUtDO0FBZUQsU0FBZ0IsVUFBVSxDQUFDLE9BQWUsRUFBRSxJQUFrRTtJQUMxRyxJQUFJLE9BQU8sT0FBTyxLQUFLLFFBQVEsRUFBRTtRQUM3QixNQUFNLElBQUksU0FBUyxDQUFDLDJEQUEyRCxDQUFDLENBQUE7S0FDbkY7SUFDRCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDMUMsTUFBTSxJQUFJLFNBQVMsQ0FBQywyRUFBMkUsQ0FBQyxDQUFBO0tBQ25HO0lBRUQsT0FBTyxDQUF1QyxNQUFTLEVBQUUsR0FBVyxFQUFFLFVBQThCLEVBQXNCLEVBQUU7UUFDeEgsS0FBSyxDQUFDLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLGlDQUFpQyxPQUFPLE9BQU8sR0FBRyxFQUFFLENBQUMsQ0FBQTtRQUVyRixJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUNsQywwQ0FBbUIsQ0FBQyxnQkFBZ0IsRUFDcEMsTUFBTSxDQUFDLFdBQVcsQ0FDeUIsQ0FBQTtRQUUvQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ1osU0FBUyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7WUFDckIsT0FBTyxDQUFDLGNBQWMsQ0FBQywwQ0FBbUIsQ0FBQyxnQkFBZ0IsRUFBRSxTQUFTLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFBO1NBQzlGO1FBQ0QsSUFBSSxpQkFBaUIsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQzlDLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUNwQixpQkFBaUIsR0FBRyxFQUFFLENBQUE7WUFDdEIsU0FBUyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsaUJBQWlCLENBQUMsQ0FBQTtTQUM1QztRQUNELGlCQUFpQixDQUFDLElBQUksQ0FBQztZQUNuQixHQUFHLEVBQUUsT0FBTztZQUNaLElBQUk7WUFDSixXQUFXLEVBQUUsVUFBVSxDQUFDLEtBQTBDO1NBQ3JFLENBQUMsQ0FBQTtRQUVGLE9BQU8sVUFBVSxDQUFBO0lBQ3JCLENBQUMsQ0FBQTtBQUNMLENBQUM7QUFqQ0QsZ0NBaUNDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBEZWNvcmF0b3JzIHRvIGRlY2xhcmUgb24gSlNPTiBkZWNvZGFibGUgY2xhc3NlcywgcHJvcGVydGllcywgYW5kIGZ1bmN0aW9uc1xuICovXG5cbmltcG9ydCAncmVmbGVjdC1tZXRhZGF0YSdcblxuaW1wb3J0ICogYXMgY3JlYXRlRGVidWdMb2cgZnJvbSAnZGVidWcnXG5cbmltcG9ydCB7IERlY29kZXJDb25zdHJ1Y3RhYmxlVGFyZ2V0LCBEZWNvZGVyTWV0YWRhdGFLZXlzLCBEZWNvZGVyUHJvdG90eXBhbFRhcmdldCB9IGZyb20gJy4uL2RlY29kZXIvZGVjb2Rlci1kZWNsYXJhdGlvbnMnXG5pbXBvcnQgeyBEZWNvZGVyUHJvdG90eXBhbENvbGxlY3Rpb25UYXJnZXQsIGlzRGVjb2RlclByb3RvdHlwYWxDb2xsZWN0aW9uVGFyZ2V0IH0gZnJvbSAnLi4vZGVjb2Rlci9kZWNvZGVyLWRlY2xhcmF0aW9ucydcbmltcG9ydCB7IERlY29kZXJNYXBFbnRyeSwgZGVjb2Rlck1hcEVudHJ5Rm9yVGFyZ2V0IH0gZnJvbSAnLi4vZGVjb2Rlci9kZWNvZGVyLW1hcCdcbmltcG9ydCB7IEpzb25Db252ZXJ0YWJsZSwgSnNvbk9iamVjdCB9IGZyb20gJy4vanNvbi1kZWNvZGFibGUtdHlwZXMnXG5pbXBvcnQgeyBKc29uRGVjb2Rlck1ldGFkYXRhS2V5cyB9IGZyb20gJy4vanNvbi1zeW1ib2xzJ1xuXG4vLyBEZWJ1ZyBsb2dnZXJcbmNvbnN0IGRlYnVnID0gY3JlYXRlRGVidWdMb2coJ2RlY29kZXI6anNvbicpXG5cbi8vXG4vLyBDbGFzcyBkZWNvcmF0b3JzXG4vL1xuXG4vKipcbiAqIE9wdGlvbnMgcHJvdmlkZWQgdG8gYSBganNvbkRlY29kYWJsZWAgY2xhc3NcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBKc29uRGVjb2RhYmxlT3B0aW9ucyB7XG4gICAgLyoqXG4gICAgICogU3RyaWN0IG1vZGVcbiAgICAgKi9cbiAgICBzdHJpY3Q/OiBib29sZWFuXG5cbiAgICAvKipcbiAgICAgKiBXaGVuIHRydWUgd2lsbCBjYWxsIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiAoZGVmYXVsdClcbiAgICAgKiBJZiBhIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGlzIG5vdCB0aGVuIG5vIFR5cGVTY3JpcHQgaW5pdGlhbGl6YXRpb24gb2YgcHJvcGVydGllcyBpcyBwZXJmb3JtZWRcbiAgICAgKi9cbiAgICB1c2VDb25zdHJ1Y3Rvcj86IGJvb2xlYW5cbn1cblxuLyoqXG4gKiBEZWNsYXJlIGEgY2xhc3MgYXMgYmVpbmcgZGVjb2RhYmxlIGZyb20gYSBKU09OIG9iamVjdFxuICpcbiAqIEBwYXJhbSBvcHRpb25zIC0gZGVjb2RlciBvcHRpb25zXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBqc29uRGVjb2RhYmxlKG9wdGlvbnM/OiBKc29uRGVjb2RhYmxlT3B0aW9ucykge1xuICAgIHJldHVybiA8VCBleHRlbmRzIERlY29kZXJQcm90b3R5cGFsVGFyZ2V0Pih0YXJnZXQ6IFQpOiBUICYgSnNvbkNvbnZlcnRhYmxlID0+IHtcbiAgICAgICAgZGVidWcoYCR7dGFyZ2V0Lm5hbWV9IGFwcGx5aW5nIGpzb25EZWNvZGFibGUgd2l0aCBvcHRpb25zICR7SlNPTi5zdHJpbmdpZnkob3B0aW9ucyl9YClcbiAgICAgICAgUmVmbGVjdC5kZWZpbmVNZXRhZGF0YShEZWNvZGVyTWV0YWRhdGFLZXlzLmRlY29kYWJsZSwgdHJ1ZSwgdGFyZ2V0KVxuXG4gICAgICAgIC8vIERlY29kYWJsZSBvcHRpb25zXG4gICAgICAgIGNvbnN0IGRlY29kYWJsZU9wdGlvbnM6IEpzb25EZWNvZGFibGVPcHRpb25zID0gey4uLm9wdGlvbnN9XG4gICAgICAgIFJlZmxlY3QuZGVmaW5lTWV0YWRhdGEoRGVjb2Rlck1ldGFkYXRhS2V5cy5kZWNvZGFibGVPcHRpb25zLCBkZWNvZGFibGVPcHRpb25zLCB0YXJnZXQpXG5cbiAgICAgICAgLy8gY29uc3QgbWFwID0gZGVjb2Rlck1hcEZvclRhcmdldCh0YXJnZXQpO1xuICAgICAgICAvLyBUT0RPOiBPdXRwdXQgdGhlIGRlY29kZXIgbWFwIGZvciB0aGUgdGFyZ2V0LiBOZWVkcyB0byBiZSBzYW5pdGl6ZSB0byBvdXRwdXQgY29ycmVjdGx5XG5cbiAgICAgICAgcmV0dXJuIDxUICYgSnNvbkNvbnZlcnRhYmxlPiB0YXJnZXRcbiAgICB9XG59XG5cbi8qKlxuICogSnNvbiBzY2hlbWEgYXMgdXNlZCBieSBhIEpTT04gZGVjb2RlYWJsZSBvYmplY3RcbiAqIFRPRE86IFVzZSBhbiBpbnRlcmZhY2UgZGVzY3JpYmluZyB0aGUgc3VwcG9ydGVkIHNjaGVtYSB2ZXJzaW9uIChub3QgYXZhaWxhYmxlIGluIGFqdilcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBKc29uRGVjb2RhYmxlU2NoZW1hIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgYW55PiB7XG4gICAgJHNjaGVtYTogc3RyaW5nXG4gICAgJGlkPzogc3RyaW5nXG59XG5cbi8qKlxuICogSW50ZXJmYWNlIGZvciBzY2hlbWEgbWV0YWRhdGEgc2V0IG9uIGEgdGFyZ2V0XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSnNvbkRlY29kZXJTY2hlbWFNZXRhZGF0YSB7XG4gICAgc2NoZW1hOiBKc29uRGVjb2RhYmxlU2NoZW1hLFxuICAgIHJlZmVyZW5jZXM/OiAoSnNvbkRlY29kYWJsZVNjaGVtYSB8IERlY29kZXJQcm90b3R5cGFsVGFyZ2V0KVtdXG59XG5cbi8qKlxuICogQW4gYXNzb2NpYXRlZCBKU09OIHNjaGVtYSB0byB2YWxpZGF0ZSB0aGUgSlNPTiB3aXRoIGJlZm9yZSBkZWNvZGluZ1xuICogU2VlIGh0dHA6Ly9qc29uLXNjaGVtYS5vcmcvXG4gKlxuICogQHBhcmFtIHNjaGVtYSAtIEpTT04gc2NoZW1hIGNvbmZpZ3VyYXRpb25cbiAqIEBwYXJhbSByZWZlcmVuY2VzIC0gSlNPTiBkZWNvZGFibGUgY2xhc3NlcyBvciBzY2hlbWEgcmVmZXJlbmNlc1xuICovXG5leHBvcnQgZnVuY3Rpb24ganNvblNjaGVtYShzY2hlbWE6IEpzb25EZWNvZGFibGVTY2hlbWEsIC4uLnJlZmVyZW5jZXM6IChKc29uRGVjb2RhYmxlU2NoZW1hIHwgRGVjb2RlclByb3RvdHlwYWxUYXJnZXQpW10pIHtcbiAgICByZXR1cm4gPFQgZXh0ZW5kcyBEZWNvZGVyUHJvdG90eXBhbFRhcmdldD4odGFyZ2V0OiBUKTogVCA9PiB7XG4gICAgICAgIGRlYnVnKGAke3RhcmdldC5uYW1lfSBhcHBseWluZyBqc29uU2NoZW1hYClcbiAgICAgICAgY29uc3Qgc2NoZW1hTWV0YWRhdGE6IEpzb25EZWNvZGVyU2NoZW1hTWV0YWRhdGEgPSB7XG4gICAgICAgICAgICBzY2hlbWEsXG4gICAgICAgICAgICByZWZlcmVuY2VzLFxuICAgICAgICB9XG4gICAgICAgIFJlZmxlY3QuZGVmaW5lTWV0YWRhdGEoSnNvbkRlY29kZXJNZXRhZGF0YUtleXMuc2NoZW1hLCBzY2hlbWFNZXRhZGF0YSwgdGFyZ2V0KVxuXG4gICAgICAgIHJldHVybiB0YXJnZXRcbiAgICB9XG59XG5cbi8vXG4vLyBQcm9wZXJ0eSBkZWNvcmF0b3JzXG4vL1xuXG4vKipcbiAqIEpTT04gY29udGV4dCBvYmplY3QgKHRoZSBvcmlnaW4gSlNPTikgYXNzaWduZWQgdG8gZGVjb2Rpbmcgb2JqZWN0XG4gKiBBbHNvIGFkZGVzIGB0b0pTT04oKWAgdG8gcmV0dXJuIHRoZSBkZWNvZGVkIG9iamVjdCBiYWNrXG4gKlxuICogQGV4YW1wbGVcbiAqICAgLy8gU2V0cyB0aGUgb3JpZ2luIEpTT04gdG8gYSBkZXNpZ25hdGVkIGNvbnRleHQgcHJvcGVydHlcbiAqICAgQGpzb25Db250ZXh0XG4gKiAgIHByaXZhdGUganNvbjogSnNvbk9iamVjdFxuICovXG5leHBvcnQgZnVuY3Rpb24ganNvbkNvbnRleHQ8VCBleHRlbmRzIERlY29kZXJDb25zdHJ1Y3RhYmxlVGFyZ2V0ICYgeyB0b0pTT04oKTogSnNvbk9iamVjdCB9Pih0YXJnZXQ6IFQsIGtleTogc3RyaW5nKSB7XG4gICAgZGVidWcoYCR7dGFyZ2V0LmNvbnN0cnVjdG9yLm5hbWV9IGFwcGx5aW5nIGpzb25Db250ZXh0IHRvICR7a2V5fWApXG4gICAgUmVmbGVjdC5kZWZpbmVNZXRhZGF0YShKc29uRGVjb2Rlck1ldGFkYXRhS2V5cy5jb250ZXh0LCBrZXksIHRhcmdldC5jb25zdHJ1Y3RvcilcblxuICAgIGNvbnN0IGRlc2NyaXB0b3IgPSBSZWZsZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSlcbiAgICBSZWZsZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCB7XG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgd3JpdGFibGU6IHRydWUsXG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICB2YWx1ZTogISFkZXNjcmlwdG9yID8gZGVzY3JpcHRvci52YWx1ZSA6IHVuZGVmaW5lZCxcbiAgICB9KVxuXG4gICAgLy8gZGVmaW5lZCB0b0pTT04gaWYgbm90IGFscmVhZHkgZGVmaW5lZFxuICAgIGlmICghKCd0b0pTT04nIGluIHRhcmdldCkpIHtcbiAgICAgICAgdGFyZ2V0Wyd0b0pTT04nXSA9IGZ1bmN0aW9uIHRvSlNPTigpIHtcbiAgICAgICAgICAgIHJldHVybiB7Li4udGhpc1trZXldfVxuICAgICAgICB9XG4gICAgfVxufVxuXG4vKipcbiAqIERlY2xhcmVzIGEgSlNPTiBkZWNvZGFibGUgcHJvcGVydHlcbiAqXG4gKiBAZXhhbXBsZVxuICogICAvLyBVc2VzICdpbmRleCcgZnJvbSBKU09OXG4gKiAgIEBqc29uUHJvcGVydHkoKVxuICogICBwcml2YXRlIGluZGV4OiBudW1iZXJcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGpzb25Qcm9wZXJ0eTxUIGV4dGVuZHMgRGVjb2RlckNvbnN0cnVjdGFibGVUYXJnZXQ+KHRhcmdldDogVCwga2V5OiBzdHJpbmcpIHtcbiAgICBkZWJ1ZyhgJHt0YXJnZXQuY29uc3RydWN0b3IubmFtZX0gYXBwbHlpbmcganNvblByb3BlcnR5IHRvICR7a2V5fWApXG5cbiAgICBjb25zdCBkZWNvZGVyTWFwID0gZGVjb2Rlck1hcEVudHJ5Rm9yVGFyZ2V0KGtleSwgdGFyZ2V0LmNvbnN0cnVjdG9yKTtcbiAgICBpZiAodHlwZW9mIGRlY29kZXJNYXAua2V5ICE9PSAnc3RyaW5nJyB8fCBkZWNvZGVyTWFwLmtleS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgZGVjb2Rlck1hcC5rZXkgPSBrZXlcbiAgICB9XG59XG5cbi8qKlxuICogRGVjbGFyZXMgYSBKU09OIGRlY29kYWJsZSBwcm9wZXJ0eSB3aXRoIG9wdGlvbmFsIGtleS9rZXktcGF0aCBhbGlhc1xuICpcbiAqIEBleGFtcGxlXG4gKiAgIC8vIFVzZXMgJ2luZGV4JyBmcm9tIEpTT04sIGFzc2lnbmVkIHRvICdfaW5kZXgnXG4gKiAgIEBqc29uUGF0aCgnaW5kZXgnKVxuICogICBwcml2YXRlIF9pbmRleDogbnVtYmVyXG4gKlxuICogICAvLyBVc2VzICdpbmRleGVzJyBmcm9tIEpTT04sIHRha2luZyB0aGUgYXJyYXkgdmFsdWUncyAwIGluZGV4XG4gKiAgIEBqc29uUGF0aCgnaW5kZXhlc1swXScpIC0gb3IgLSBAanNvblBhdGgoJ2luZGV4ZXNAMCcpXG4gKiAgIHByaXZhdGUgaW5kZXg6IG51bWJlclxuICpcbiAqICAgLy8gVXNlcyAndGFyZ2V0OiB7IGluZGV4IH0nIGZyb20gSlNPTlxuICogICBAanNvblBhdGgoJ3RhcmdldC5pbmRleCcpXG4gKiAgIHByaXZhdGUgaW5kZXg6IG51bWJlclxuICpcbiAqIEBwYXJhbSBrZXlQYXRoIC0gcGF0aCB0byB0aGUgcHJvcGVydHksIG9yIHVuZGVmaW5lZCB0byB1c2UgcHJvcGVydHkgbmFtZVxuICovXG5leHBvcnQgZnVuY3Rpb24ganNvblByb3BlcnR5QWxpYXMoa2V5UGF0aDogc3RyaW5nKSB7XG4gICAgaWYgKHR5cGVvZiBrZXlQYXRoICE9PSAnc3RyaW5nJyB8fCBrZXlQYXRoLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdqc29uUHJvcGVydHkoa2V5UGF0aCkgc2hvdWxkIGJlIGEgbm9uLWVtcHR5IFN0cmluZycpXG4gICAgfVxuXG4gICAgcmV0dXJuICh0YXJnZXQ6IERlY29kZXJDb25zdHJ1Y3RhYmxlVGFyZ2V0LCBrZXk6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBkZWNvZGVyTWFwID0gZGVjb2Rlck1hcEVudHJ5Rm9yVGFyZ2V0KGtleSwgdGFyZ2V0LmNvbnN0cnVjdG9yKVxuICAgICAgICAvLyBUT0RPOiBDb21waWxlIHRoZSBwYXRoIGhlcmUgaW5zdGVhZCBvZiBlYWNoIGRlY29kZVxuICAgICAgICBkZWNvZGVyTWFwLmtleSA9IGtleVBhdGhcbiAgICB9XG59XG5cbi8qKlxuICogQXV0b21hdGljYWxseSBtYXBzIChtYXJzaGFscykgYSB2YWx1ZSBmcm9tIGEgSlNPTiBwcm9wZXJ0eSB2YWx1ZSBpbnRvIGEgZGVzaXJlZCB0eXBlXG4gKlxuICogQGV4YW1wbGVcbiAqICAgLy8gRW5zdXJlcyBhIE51bWJlciB2YWx1ZSB3aWxsIGJlIGFzc2lnbmVkIHRvICdpbmRleCcsIG1hcHBlZCBhcHByb3ByaWF0ZWx5XG4gKiAgIEBqc29uUHJvcGVydHkoKVxuICogICBAanNvblR5cGUoTnVtYmVyKVxuICogICBwcml2YXRlIGluZGV4OiBudW1iZXJcbiAqXG4gKiAgIC8vIEVuc3VyZXMgYSBVUkwgdmFsdWUgd2lsbCBiZSBhc3NpZ25lZCB0byAnZW5kcG9pbnQnLCBtYXJzaGFsbGVkIGZyb20gYSBzdHJpbmcgYXBwcm9wcmlhdGVseVxuICogICBAanNvblByb3BlcnR5KClcbiAqICAgQGpzb25UeXBlKFVSTClcbiAqICAgcHJpdmF0ZSBpbmRleDogVVJMXG4gKlxuICogICAvLyBFbnN1cmVzIHRoZSBkZWNvZGVkIHZhbHVlIHdpbGwgYmUgYSBzdHJpbmcsIGFuZCB1c2VzIHRoZSBzdHJpbmcgd2l0aCBhIGN1c3RvbSBtYXAgZnVuY3Rpb25cbiAqICAgQGpzb25Qcm9wZXJ0eSgpXG4gKiAgIEBqc29uVHlwZShTdHJpbmcsICh2YWx1ZTogc3RyaW5nKSA9PiBuZXcgUmVnRXguY29tcGlsZSh2YWx1ZSkpXG4gKiAgIHByaXZhdGUgcGF0dGVybjogUmVnRXhcbiAqXG4gKiBAcGFyYW0gdHlwZSAtIG1hcnNoYWxsYWJsZSB0eXBlXG4gKiBAcGFyYW0gW21hcEZ1bmN0aW9uXSAtIG9wdGlvbmFsIGZ1bmN0aW9uIHRha2luZyBhbiBpbnN0YW5jZSBvZiBgdHlwZWBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGpzb25UeXBlKFxuICAgIHR5cGU6IERlY29kZXJQcm90b3R5cGFsVGFyZ2V0IHwgRGVjb2RlclByb3RvdHlwYWxDb2xsZWN0aW9uVGFyZ2V0LFxuICAgIG1hcEZ1bmN0aW9uPzogKHZhbHVlOiBhbnkpID0+IGFueSxcbikge1xuICAgIGlmIChBcnJheS5pc0FycmF5KHR5cGUpICYmIHR5cGUubGVuZ3RoICE9PSAxKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2pzb25UeXBlKHR5cGUpIHNob3VsZCBoYXZlIGV4YWN0bHkgb25lIGVsZW1lbnQgZm9yIEFycmF5IHR5cGVzJylcbiAgICB9XG5cbiAgICByZXR1cm4gKHRhcmdldDogRGVjb2RlckNvbnN0cnVjdGFibGVUYXJnZXQsIGtleTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IGRlY29kZXJNYXBFbnRyeSA9IGRlY29kZXJNYXBFbnRyeUZvclRhcmdldChrZXksIHRhcmdldC5jb25zdHJ1Y3RvcilcblxuICAgICAgICBjb25zdCBlbGVtZW50VHlwZSA9IGlzRGVjb2RlclByb3RvdHlwYWxDb2xsZWN0aW9uVGFyZ2V0KHR5cGUpID8gdHlwZS5jb2xsZWN0aW9uIDogdHlwZVxuICAgICAgICBkZWJ1ZyhgJHt0YXJnZXQuY29uc3RydWN0b3IubmFtZX0gYXBwbHlpbmcganNvblR5cGUgdG8gJHtrZXl9LCBtYXJzaGFsbGluZyB1c2luZyAke2VsZW1lbnRUeXBlLm5hbWV9YClcblxuICAgICAgICBkZWNvZGVyTWFwRW50cnkudHlwZSA9IHR5cGVcbiAgICAgICAgZGVjb2Rlck1hcEVudHJ5Lm1hcEZ1bmN0aW9uID0gbWFwRnVuY3Rpb25cbiAgICB9XG59XG5cbi8vXG4vLyBGdW5jdGlvbiBkZWNvcmF0b3JzXG4vL1xuXG4vKipcbiAqIERlY2xhcmVzIGEgZnVuY3Rpb24gYXMgYmVpbmcgdGhlIGRlY29kZXIgY2xhc3MgZmFjdG9yeSwgcmV0dXJuaW5nIHRoZSBjbGFzcyB0byBpbnN0YXRpYXRlIHdpdGggdGhlIEpTT04gZGVjb2RlclxuICpcbiAqIEBleGFtcGxlXG4gKiAgIEBqc29uRGVjb2RlckZhY3RvcnlcbiAqICAgc3RhdGljIGRlY29kZXJDbGFzc0ZhY3RvcnkoanNvbjogSnNvbk9iamVjdCkge1xuICogICAgICAgLy8gSWYgJ3R5cGUnIGlzICdzcGVjaWFsJyBpbiBvdXIgSlNPTiBvYmplY3QsIHJldHVybiBNeVNwZWNpYWxDbGFzcyB0byBkZWNvZGVcbiAqICAgICAgIGlmICgndHlwZScgaW4ganNvbiAmJiBqc29uLnR5cGUgPT09ICdzcGVjaWFsJykge1xuICogICAgICAgICAgIHJldHVybiBuZXcgTXlTcGVjaWFsQ2xhc3MoKVxuICogICAgICAgfVxuICpcbiAqICAgICAgIHJldHVybiBNeUNsYXNzKClcbiAqICAgfVxuICovXG5leHBvcnQgZnVuY3Rpb24ganNvbkRlY29kZXJGYWN0b3J5KHRhcmdldDogRGVjb2RlclByb3RvdHlwYWxUYXJnZXQsIGtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3IpOiBQcm9wZXJ0eURlc2NyaXB0b3Ige1xuICAgIGRlYnVnKGAke3RhcmdldC5uYW1lfSBhcHBseWluZyBqc29uRGVjb2RlckZhY3RvcnkgdG8gJHtrZXl9YClcbiAgICBSZWZsZWN0LmRlZmluZU1ldGFkYXRhKERlY29kZXJNZXRhZGF0YUtleXMuZGVjb2RlckZhY3RvcnksIHRhcmdldFtrZXldLCB0YXJnZXQpXG5cbiAgICByZXR1cm4gZGVzY3JpcHRvclxufVxuXG4vKipcbiAqIFNwZWNpZmllcyB0aGUgZGVjb2RlciBmdW5jdGlvbi4gVGhpcyBkZWNvcmF0aW9uIGJlaGF2ZXMgZGlmZmVyZW50bHkgZGVwZW5kaW5nIG9uIHRoZSBwbGFjZW1lbnQgb24gdGhlXG4gKiBjbGFzcyhzdGF0aWMgZnVuY3Rpb24pL2NvbnN0cnVjdG9yIGZ1bmN0aW9uIGl0c2VsZiwgb3Igb24gdGhlIGNsYXNzIHByb3RvdHlwZS4gQm90aCBtYXkgYmUgdXNlZCwgaWYgZGVzaXJlZC5cbiAqIEluIGJvdGggY2FzZSB0aGUgc291cmNlIEpTT04gb2JqZWN0IHdpbGwgYmUgc3VwcGxpZWQgdG8gYWlkIGRlY29kaW5nLlxuICpcbiAqIFdoZW4gYXBwbGllZCB0byB0aGUgY2xhc3MgKHN0YXRpYyBmdW5jdGlvbikgdGhlIGRlY29kZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gdGhlIGRlY29kZWQgb2JqZWN0LCBvciBpbml0aWFsaXplXG4gKiBhbmQgb2JqZWN0IHRvIGJlZ2luIGRlY29kaW5nLiBSZXR1cm5pbmcgdW5kZWZpbmVkIHdpbGwgZmFsbGJhY2sgdG8gdGhlIGRlZmF1bHQgb2JqZWN0IGNyZWF0aW9uLCByZXR1cm5pbmcgbnVsbCB3aWxsXG4gKiBpbnZhbGlkYXRlIGRlY29kaW5nLlxuICpcbiAqIFdoZW4gYXBwbGllZCB0byBhIHByb3RvdHlwZSBmdW5jdGlvbiwgdGhlIGRlY29kaW5nIG9iamVjdCB3aWxsIGhhdmUgYmVlbiBjcmVhdGVkLiBUaGUgZnVuY3Rpb24gbXVzdCByZXR1cm4gdGhpcyBvclxuICogYSByZXBsYWNlbWVudCBvYmplY3QuIFJldHVybmluZyB1bmRlZmluZWQgd2lsbCBmYWxsYmFjayBhbmQgdXNlIHRoZSBzYW1lIGRlY29kaW5nIG9iamVjdCBhbHJlYWR5IGNyZWF0ZWQsIHJldHVybmluZ1xuICogbnVsbGwgd2lsbCBpbnZhbGlkYXRlIHRoZSBkZWNvZGluZy5cbiAqXG4gKiBFcnJvcnMgdGhyb3duIGhlcmUgd2lsbCBiZSBwcm9wYWdhdGVkXG4gKlxuICogQGV4YW1wbGVcbiAqICAgQGpzb25EZWNvZGVyXG4gKiAgIHB1YmxpYyBkZWNvZGVyKGpzb246IE9iamVjdCk6IE15Q2xhc3MgfCBudWxsIHsgLi4uIH1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGpzb25EZWNvZGVyKHRhcmdldDogRGVjb2RlckNvbnN0cnVjdGFibGVUYXJnZXQsIGtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3IpOiBQcm9wZXJ0eURlc2NyaXB0b3Ige1xuICAgIGRlYnVnKGAke3RhcmdldC5jb25zdHJ1Y3Rvci5uYW1lfSBhcHBseWluZyBqc29uRGVjb2RlciB0byAke2tleX1gKVxuICAgIFJlZmxlY3QuZGVmaW5lTWV0YWRhdGEoRGVjb2Rlck1ldGFkYXRhS2V5cy5kZWNvZGVyLCB0YXJnZXRba2V5XSwgdGFyZ2V0KVxuXG4gICAgcmV0dXJuIGRlc2NyaXB0b3Jcbn1cblxuLyoqXG4gKiBTcGVjaWZpZXMgdGhlIGZ1bmN0aW9uIGNhbGxlZCBvbiB0aGUgZGVjb2RlZCBvYmplY3Qgd2hlbiBkZWNvZGluZyBoYXMgY29tcGxldGVkLiBBdCB0aGlzIHBvaW50IGFsbCBwcm9wZXJ0aWVzIGhhdmVcbiAqIGJlZW4gYXNzaWduZWQsIGFuZCBhbGwgcHJvcGVydHkgaGFuZGxlciBmdW5jdGlvbnMgY2FsbGVkLiBganNvbkRlY29kZXJDb21wbGV0ZWRgIG9ubHkgY2FuIGJlIGNhbGxlZCBvbiBwcm90b3R5cGVcbiAqIGZ1bmN0aW9ucywgYW5kIHByb3ZpZGVzIGEgbGFzdCBjaGFuY2UgdG8gcGVyZm9ybSBhbnkgYWRkaXRpb25hbCBkZWNvZGluZywgdmFsaWRhdGlvbiwgb3IgaW52YWxpZGF0aW9uLlxuICpcbiAqIExpa2UgYGpzb25EZWNvZGVyYCByZXR1cm5pbmcgYG51bGxgIGludmFsaWRhdGVzIHRoZSBkZWNvZGVkIG9iamVjdC5cbiAqXG4gKiBFcnJvcnMgdGhyb3duIGhlcmUgd2lsbCBiZSBwcm9wYWdhdGVkXG4gKlxuICogQGV4YW1wbGVcbiAqICAgQGpzb25EZWNvZGVyQ29tcGxldGVcbiAqICAgZnVuY3Rpb24gZGVjb2Rlcihqc29uOiBPYmplY3QpOiBNeUNsYXNzIHwgbnVsbCB7IC4uLiB9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBqc29uRGVjb2RlckNvbXBsZXRlZCh0YXJnZXQ6IERlY29kZXJDb25zdHJ1Y3RhYmxlVGFyZ2V0LCBrZXk6IHN0cmluZywgZGVzY3JpcHRvcjogUHJvcGVydHlEZXNjcmlwdG9yKTogUHJvcGVydHlEZXNjcmlwdG9yIHtcbiAgICBkZWJ1ZyhgJHt0YXJnZXQuY29uc3RydWN0b3IubmFtZX0gYXBwbHlpbmcganNvbkRlY29kZXJDb21wbGV0ZWQgdG8gJHtrZXl9YClcbiAgICBSZWZsZWN0LmRlZmluZU1ldGFkYXRhKERlY29kZXJNZXRhZGF0YUtleXMuZGVjb2RlckNvbXBsZXRlZCwgdGFyZ2V0W2tleV0sIHRhcmdldClcblxuICAgIHJldHVybiBkZXNjcmlwdG9yXG59XG5cbi8qKlxuICogQXNzb2NpYXRlcyBhIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIGEgSlNPTiBwcm9wZXJ0eSBvZiBhIGdpdmVuIGtleSBwYXRoIGlzIGZvdW5kLlxuICpcbiAqIEBleGFtcGxlXG4gKiAgIGpzb25Ob3RpZnkoJ2luZGV4JywgTnVtYmVyKVxuICogICBwcml2YXRlIG9uSW5kZXgoaW5kZXg6IG51bWJlciwganNvbjogSnNvbk9iamVjdCkge1xuICogICAgIC8vIERvIHNvbWV0aGluZyB3aXRoIGluZGV4XG4gKiAgICAgLy8gJ3RoaXMnIGlzIHNldCB0byB0aGUgb2JqZWN0IGJlaW5nIGNvZGVkXG4gKiAgIH1cbiAqXG4gKiBAcGFyYW0ga2V5UGF0aCAtIGtleSBwYXRoIHRvIHRoZSBwcm9wZXJ0eSBmcm9tIHRoZSByb290IGZvciB0aGUgSlNPTlxuICogQHBhcmFtIFt0eXBlPXVuZGVmaW5lZF0gLSB0eXBlIGRlY2xhcmF0aW9uIHNpbWlsYXIgdG8ganNvblR5cGUgdG8gYXV0b21hdGljYWxseSBtYXAgdGhlIHByb3BlcnR5IHRvXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBqc29uTm90aWZ5KGtleVBhdGg6IHN0cmluZywgdHlwZT86IERlY29kZXJQcm90b3R5cGFsVGFyZ2V0IHwgRGVjb2RlclByb3RvdHlwYWxDb2xsZWN0aW9uVGFyZ2V0KSB7XG4gICAgaWYgKHR5cGVvZiBrZXlQYXRoICE9PSAnc3RyaW5nJykge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdqc29uUHJvcGVydHlIYW5kbGVyKGtleVBhdGgpIHNob3VsZCBiZSBhIG5vbi1lbXB0eSBTdHJpbmcnKVxuICAgIH1cbiAgICBpZiAoQXJyYXkuaXNBcnJheSh0eXBlKSAmJiB0eXBlLmxlbmd0aCAhPT0gMSkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdqc29uUHJvcGVydHlIYW5kbGVyKHR5cGUpIHNob3VsZCBoYXZlIGV4YWN0bHkgb25lIGVsZW1lbnQgZm9yIEFycmF5IHR5cGVzJylcbiAgICB9XG5cbiAgICByZXR1cm4gPFQgZXh0ZW5kcyBEZWNvZGVyQ29uc3RydWN0YWJsZVRhcmdldD4odGFyZ2V0OiBULCBrZXk6IHN0cmluZywgZGVzY3JpcHRvcjogUHJvcGVydHlEZXNjcmlwdG9yKTogUHJvcGVydHlEZXNjcmlwdG9yID0+IHtcbiAgICAgICAgZGVidWcoYCR7dGFyZ2V0LmNvbnN0cnVjdG9yLm5hbWV9IGFwcGx5aW5nIGpzb25Qcm9wZXJ0eUhhbmRsZXIgJHtrZXlQYXRofSB0byAke2tleX1gKVxuXG4gICAgICAgIGxldCBub3RpZmllcnMgPSBSZWZsZWN0LmdldE93bk1ldGFkYXRhKFxuICAgICAgICAgICAgRGVjb2Rlck1ldGFkYXRhS2V5cy5kZWNvZGVyTm90aWZpZXJzLFxuICAgICAgICAgICAgdGFyZ2V0LmNvbnN0cnVjdG9yLFxuICAgICAgICApIGFzIE1hcDxzdHJpbmcsIERlY29kZXJNYXBFbnRyeVtdPiB8IHVuZGVmaW5lZFxuXG4gICAgICAgIGlmICghbm90aWZpZXJzKSB7XG4gICAgICAgICAgICBub3RpZmllcnMgPSBuZXcgTWFwKClcbiAgICAgICAgICAgIFJlZmxlY3QuZGVmaW5lTWV0YWRhdGEoRGVjb2Rlck1ldGFkYXRhS2V5cy5kZWNvZGVyTm90aWZpZXJzLCBub3RpZmllcnMsIHRhcmdldC5jb25zdHJ1Y3RvcilcbiAgICAgICAgfVxuICAgICAgICBsZXQgcHJvcGVydHlOb3RpZmllcnMgPSBub3RpZmllcnMuZ2V0KGtleVBhdGgpXG4gICAgICAgIGlmICghcHJvcGVydHlOb3RpZmllcnMpIHtcbiAgICAgICAgICAgIHByb3BlcnR5Tm90aWZpZXJzID0gW11cbiAgICAgICAgICAgIG5vdGlmaWVycy5zZXQoa2V5UGF0aCwgcHJvcGVydHlOb3RpZmllcnMpXG4gICAgICAgIH1cbiAgICAgICAgcHJvcGVydHlOb3RpZmllcnMucHVzaCh7XG4gICAgICAgICAgICBrZXk6IGtleVBhdGgsXG4gICAgICAgICAgICB0eXBlLFxuICAgICAgICAgICAgbWFwRnVuY3Rpb246IGRlc2NyaXB0b3IudmFsdWUgYXMgKCh2YWx1ZTogYW55KSA9PiBhbnkpIHwgdW5kZWZpbmVkLFxuICAgICAgICB9KVxuXG4gICAgICAgIHJldHVybiBkZXNjcmlwdG9yXG4gICAgfVxufVxuIl19